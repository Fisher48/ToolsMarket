<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title th:text="${product.name} + ' - ToolStore'">–¢–æ–≤–∞—Ä - ToolsMarket48</title>

    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary: #0d2e67;      /* —Ç–µ–º–Ω–æ-—Å–∏–Ω–∏–π */
            --primary-dark: #0a1f3f; /* –µ—â–µ —Ç–µ–º–Ω–µ–µ */
            --primary-light: #2a4b8c; /* —Å–≤–µ—Ç–ª–µ–µ */

            /* –ö—Ä–∞—Å–Ω—ã–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è */
            --accent: #E63946;

            /* –¢–µ–Ω–∏ */
            --shadow-sm: 0 2px 8px rgba(84, 110, 122, 0.08);
            --shadow-md: 0 4px 16px rgba(84, 110, 122, 0.12);
        }

        body {
            background-color: var(--primary-light);
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        /* ===== SWIPER –°–¢–ò–õ–ò ===== */
        .main-swiper {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        .main-swiper .swiper-slide {
            background: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .main-swiper .swiper-slide img {
            width: 100%;
            height: 450px;
            object-fit: contain;
            background-color: white;
            transition: opacity 0.2s;
        }

        .main-swiper .swiper-slide img:active {
            opacity: 0.9;
        }

        /* Thumbnail Swiper */
        .thumb-swiper {
            height: 90px;
            margin-top: 10px;
        }

        .thumb-swiper .swiper-slide {
            width: 80px;
            height: 80px;
            opacity: 0.6;
            transition: all 0.2s;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .thumb-swiper .swiper-slide-thumb-active {
            opacity: 1;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(13, 110, 253, 0.3);
        }

        .thumb-swiper .swiper-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .swiper-button-next,
        .swiper-button-prev {
            color: var(--primary);
            background: rgba(255, 255, 255, 0.9);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .swiper-button-next:hover,
        .swiper-button-prev:hover {
            background: white;
            transform: scale(1.1);
        }

        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 20px;
            font-weight: bold;
        }

        .swiper-pagination-bullet-active {
            background: var(--primary-light);
        }

        /* ===== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û ===== */
        .swiper-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 99999;
            display: none;
        }

        .swiper-modal .swiper {
            height: 100vh;
            width: 100vw;
        }

        .swiper-modal .swiper-slide {
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .swiper-modal .swiper-slide img {
            width: 100%;
            height: 100vh;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 48px;
            cursor: pointer;
            z-index: 100000;
            opacity: 0.8;
            transition: opacity 0.2s;
            line-height: 1;
            background: none;
            border: none;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .close-modal:hover {
            opacity: 1;
        }

        .swiper-modal .swiper-button-next,
        .swiper-modal .swiper-button-prev {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: none;
        }

        .swiper-modal .swiper-button-next:hover,
        .swiper-modal .swiper-button-prev:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .swiper-modal .swiper-pagination-bullet {
            background: white;
            opacity: 0.5;
        }

        .swiper-modal .swiper-pagination-bullet-active {
            background: white;
            opacity: 1;
        }

        /* ===== –°–¢–ò–õ–ò –¢–û–í–ê–†–ê ===== */
        .cart-management-widget {
            background: #fff;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .quantity-controls-full-width {
            display: flex;
            width: 100%;
            border: 2px solid var(--primary);
            border-radius: 50px;
            overflow: hidden;
            background: var(--primary);
            height: 50px;
        }

        .quantity-btn-full-width {
            flex: 1;
            height: 100%;
            border: none;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 24px;
            font-weight: 600;
            padding: 0;
        }

        .quantity-btn-full-width:hover {
            background: var(--primary-dark);
        }

        .quantity-btn-full-width:active {
            background: var(--primary-light);
        }

        .quantity-display-full-width {
            flex: 1;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: white;
            background: var(--black-coral);
            border-left: 2px solid var(--primary-light);
            border-right: 2px solid var(--primary-light);
            min-width: 60px;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É" */
        #add-to-cart-btn.btn-primary {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            border: none;
            border-radius: 50px;
            font-weight: 700 !important;
            font-size: 1.3rem !important;
            color: white;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        #add-to-cart-btn.btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é" */
        a[href="/cart"].btn-primary {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            border: none;
            border-radius: 50px;
            font-weight: 600;
            color: white;
            transition: all 0.3s ease;
        }

        a[href="/cart"].btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" */
        #remove-btn.btn-outline-danger {
            border-radius: 50px;
            border: 2px solid var(--accent);
            color: var(--accent);
            transition: all 0.3s ease;
        }

        #remove-btn.btn-outline-danger:hover {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(230, 57, 70, 0.3);
        }

        .bg-light-success {
            background-color: rgba(25, 135, 84, 0.08);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .main-swiper .swiper-slide img {
                height: 350px;
            }

            .thumb-swiper {
                height: 70px;
            }

            .thumb-swiper .swiper-slide {
                width: 60px;
                height: 60px;
            }

            .swiper-button-next,
            .swiper-button-prev {
                display: none;
            }

            .close-modal {
                top: 10px;
                right: 20px;
                font-size: 40px;
            }
        }

        @media (max-width: 480px) {
            .main-swiper .swiper-slide img {
                height: 280px;
            }

            .thumb-swiper .swiper-slide {
                width: 50px;
                height: 50px;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-out {
            animation: fadeOut 0.3s ease;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
    </style>
</head>
<body>
<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<main class="container my-4">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-light p-3 rounded">
            <li class="breadcrumb-item"><a th:href="@{/}" class="text-decoration-none">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li th:each="cat : ${product.categories}" class="breadcrumb-item">
                <a th:href="@{/category/{title}(title=${cat.title})}"
                   class="text-decoration-none"
                   th:text="${cat.name}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</a>
            </li>
            <li class="breadcrumb-item active" th:text="${product.name}">–¢–æ–≤–∞—Ä</li>
        </ol>
    </nav>

    <!-- Product Details -->
    <div class="row g-4">
        <!-- Product Images - SWIPER -->
        <div class="col-lg-6">
            <th:block th:if="${product.images != null and not #lists.isEmpty(product.images)}">
                <!-- –û—Å–Ω–æ–≤–Ω–æ–π Swiper -->
                <div class="swiper main-swiper">
                    <div class="swiper-wrapper">
                        <div th:each="image, stat : ${product.images}" class="swiper-slide">
                            <img th:src="${image.url}"
                                 th:alt="${image.alt != null ? image.alt : product.name}"
                                 th:attr="data-index=${stat.index}"
                                 onclick="openModalSwiper(this.dataset.index)">
                        </div>
                    </div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-pagination"></div>
                </div>

                <!-- Thumbnail Swiper -->
                <div class="swiper thumb-swiper">
                    <div class="swiper-wrapper">
                        <div th:each="image, stat : ${product.images}" class="swiper-slide">
                            <img th:src="${image.url}"
                                 th:alt="${image.alt != null ? image.alt : product.name}">
                        </div>
                    </div>
                </div>
            </th:block>

            <!-- Placeholder –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ -->
            <th:block th:if="${product.images == null or #lists.isEmpty(product.images)}">
                <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                    <i class="bi bi-image text-secondary" style="font-size: 64px;"></i>
                </div>
            </th:block>
        </div>

        <!-- Product Info -->
        <div class="col-lg-6">
            <h1 class="mb-3" th:text="${product.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h1>

            <!-- Price -->
            <div class="mb-4">
                <div th:if="${product.hasDiscount != null and product.hasDiscount}">
                    <div class="d-flex align-items-center gap-2">
                            <span class="display-5 fw-bold text-danger"
                                  th:text="${product.formattedDiscountedPrice}">1 990 ‚ÇΩ</span>
                        <span class="text-muted text-decoration-line-through fs-4"
                              th:text="${product.formattedPrice}">2 990 ‚ÇΩ</span>
                    </div>
                </div>
                <div th:unless="${product.hasDiscount != null and product.hasDiscount}">
                        <span class="display-5 fw-bold text-primary"
                              th:text="${product.formattedPrice}">1 990 ‚ÇΩ</span>
                </div>
                <span th:if="${product.sku != null and !product.sku.isEmpty()}"
                      class="text-muted ms-2"
                      th:text="'–ê—Ä—Ç–∏–∫—É–ª: ' + ${product.sku}">
                    </span>
            </div>

            <!-- Status -->
            <div class="mb-4">
                    <span th:if="${product.active}"
                          class="badge bg-success fs-6 px-3 py-2">
                        <i class="bi bi-check-circle me-1"></i> –í –Ω–∞–ª–∏—á–∏–∏
                    </span>
                <span th:if="${product.active != null and !product.active}"
                      class="badge bg-secondary fs-6 px-3 py-2">
                        <i class="bi bi-x-circle me-1"></i> –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    </span>
            </div>

            <!-- Short Description -->
            <div th:if="${product.shortDescription != null and !product.shortDescription.isEmpty()}"
                 class="lead mb-4 p-3 bg-light rounded"
                 th:text="${product.shortDescription}">
            </div>

            <!-- Add to Cart -->
            <div class="mb-4" id="cart-section" th:data-product-id="${product.id}">
                <!-- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ) -->
                <div id="cart-management-section" class="cart-management-widget" style="display: none;">
                    <div class="alert alert-success border-0 bg-light-success mb-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-check-circle-fill text-success fs-3"></i>
                            <div class="ms-3">
                                <h6 class="mb-1">–¢–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω–µ</h6>
                                <p class="mb-0">
                                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:
                                    <span class="badge bg-success rounded-pill fs-6 px-3 py-2"
                                          id="cartQuantity">0</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="mb-2 fw-medium">–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:</div>
                        <div class="quantity-controls-full-width">
                            <button type="button"
                                    class="quantity-btn-full-width"
                                    onclick="decreaseFromCart(this)"
                                    id="decrease-btn">
                                <i class="bi bi-dash-lg"></i>
                            </button>
                            <span class="quantity-display-full-width" id="cartQuantityValue">0</span>
                            <button type="button"
                                    class="quantity-btn-full-width"
                                    onclick="addToCart(this)"
                                    id="increase-btn">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <a th:href="@{/cart}" class="btn btn-primary btn-lg py-3">
                            <i class="bi bi-cart-check me-2"></i>–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
                        </a>
                        <button type="button"
                                class="btn btn-outline-danger btn-lg py-3"
                                onclick="removeFromCart(this)"
                                id="remove-btn">
                            <i class="bi bi-trash me-2"></i>–£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>

                <!-- –ë–ª–æ–∫ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É" -->
                <div id="add-to-cart-section" style="display: none;">
                    <button th:if="${product.active}"
                            type="button"
                            class="btn btn-primary btn-lg w-100 py-3 fw-bold"
                            onclick="addToCart(this)"
                            id="add-to-cart-btn">
                        <i class="bi bi-cart-plus me-2"></i>
                        <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</span>
                    </button>
                    <button th:if="${product.active != null and !product.active}"
                            class="btn btn-secondary btn-lg w-100 py-3" disabled>
                        <i class="bi bi-envelope me-2"></i> –£–≤–µ–¥–æ–º–∏—Ç—å –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏
                    </button>
                </div>
            </div>

            <!-- Categories -->
            <div th:if="${product.categories != null and not #lists.isEmpty(product.categories)}">
                <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong>
                <div class="mt-2">
                    <a th:each="cat : ${product.categories}"
                       th:href="@{/category/{title}(title=${cat.title})}"
                       class="badge bg-light text-dark text-decoration-none me-1 p-2"
                       th:text="${cat.name}">
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Tabs -->
    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab"
                            data-bs-target="#description" type="button" role="tab">
                        –û–ø–∏—Å–∞–Ω–∏–µ
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="specs-tab" data-bs-toggle="tab"
                            data-bs-target="#specs" type="button" role="tab">
                        –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                    </button>
                </li>
            </ul>

            <div class="tab-content p-4 border border-top-0 rounded-bottom bg-white">
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <div th:if="${product.description != null and !product.description.isEmpty()}"
                         th:utext="${product.description}">
                    </div>
                    <div th:unless="${product.description != null and !product.description.isEmpty()}"
                         class="text-muted text-center py-4">
                        <i class="bi bi-file-text fs-1"></i>
                        <p class="mt-2">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                    </div>
                </div>
                <div class="tab-pane fade" id="specs" role="tabpanel">
                    <div th:if="${product.attributeValues != null and not #lists.isEmpty(product.attributeValues)}">
                        <table class="table table-striped">
                            <tbody>
                            <tr th:each="attrValue : ${product.attributeValues}">
                                <th style="width: 40%" th:text="${attrValue.attributeName}">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞</th>
                                <td>
                                    <span th:text="${attrValue.value}">–ó–Ω–∞—á–µ–Ω–∏–µ</span>
                                    <small th:if="${attrValue.attributeUnit != null and !attrValue.attributeUnit.isEmpty()}"
                                           class="text-muted ms-1"
                                           th:text="${attrValue.attributeUnit}"></small>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div th:unless="${product.attributeValues != null and not #lists.isEmpty(product.attributeValues)}"
                         class="text-center text-muted py-5">
                        <i class="bi bi-info-circle fs-1"></i>
                        <p class="mt-3">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/footer :: #site-footer}"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="swiper-modal" id="modalSwiper">
    <button class="close-modal" onclick="closeModalSwiper()">&times;</button>
    <div class="swiper modal-main-swiper">
        <div class="swiper-wrapper" id="modalSwiperWrapper"></div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
    </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let modalSwiper = null;
    let mainSwiper = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ Swiper
        mainSwiper = new Swiper('.main-swiper', {
            slidesPerView: 1,
            spaceBetween: 0,
            loop: false,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            thumbs: {
                swiper: new Swiper('.thumb-swiper', {
                    slidesPerView: 'auto',
                    spaceBetween: 10,
                    freeMode: true,
                    watchSlidesProgress: true,
                    breakpoints: {
                        320: { slidesPerView: 3 },
                        480: { slidesPerView: 4 },
                        768: { slidesPerView: 5 },
                        1024: { slidesPerView: 6 }
                    }
                })
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã
        loadCartState();
    });

    // ===== –§–£–ù–ö–¶–ò–ò –ú–û–î–ê–õ–ö–ò =====
    window.openModalSwiper = function(index) {
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —á–∏—Å–ª–æ
        index = parseInt(index, 10);
        console.log('üì∏ –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ç–æ ‚Ññ', index + 1);

        const modal = document.getElementById('modalSwiper');
        const wrapper = document.getElementById('modalSwiperWrapper');

        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const images = Array.from(document.querySelectorAll('.main-swiper .swiper-slide img')).map(img => ({
            url: img.src,
            alt: img.alt
        }));

        if (images.length === 0) return;

        // –û—á–∏—â–∞–µ–º –∏ –Ω–∞–ø–æ–ª–Ω—è–µ–º wrapper
        wrapper.innerHTML = '';
        images.forEach(img => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `
            <div class="swiper-zoom-container">
                <img src="${img.url}" alt="${img.alt}">
            </div>
        `;
            wrapper.appendChild(slide);
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden';

        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—Ç–∞—Ä—ã–π Swiper
        if (modalSwiper) {
            modalSwiper.destroy(true, true);
        }

        // –°–û–ó–î–ê–Å–ú –ù–û–í–´–ô –° –£–ö–ê–ó–ê–ù–ù–´–ú –ò–ù–î–ï–ö–°–û–ú
        modalSwiper = new Swiper('.modal-main-swiper', {
            initialSlide: index,  // ‚Üê –í–ê–ñ–ù–û: —Å—Ç–∞–≤–∏–º –Ω—É–∂–Ω—ã–π –∏–Ω–¥–µ–∫—Å
            slidesPerView: 1,
            spaceBetween: 0,
            loop: false,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            zoom: {
                maxRatio: 3,
                minRatio: 1,
                toggle: true,
            }
        });
    };

    window.closeModalSwiper = function() {
        const modal = document.getElementById('modalSwiper');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    };

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('modalSwiper');
        if (modal && modal.style.display === 'block' && e.key === 'Escape') {
            closeModalSwiper();
        }
    });

    // ===== –§–£–ù–ö–¶–ò–ò –ö–û–†–ó–ò–ù–´ =====
    const productId = /*[[${product.id}]]*/ null;
    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

    async function cartRequest(endpoint, data = {}) {
        const headers = {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        };

        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        try {
            const response = await fetch(`/api/cart${endpoint}`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(data)
            });

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –¥–ª—è header
            window.dispatchEvent(new CustomEvent('cart-updated', {
                detail: { totalQuantity: result.totalQuantity }
            }));

            return result;
        } catch (error) {
            console.error('Cart request error:', error);
            showNotification(error.message || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞', 'danger');
            throw error;
        }
    }

    async function addToCart(button) {
        if (!productId) {
            showNotification('ID —Ç–æ–≤–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
            return;
        }

        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        button.disabled = true;

        try {
            const result = await cartRequest('/add', { productId, quantity: 1 });
            updateCartUI(result);
            showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É', 'success');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    async function decreaseFromCart(button) {
        if (!productId) {
            showNotification('ID —Ç–æ–≤–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
            return;
        }

        button.disabled = true;

        try {
            const result = await cartRequest('/decrease', { productId });
            updateCartUI(result);
            const quantity = result.quantities?.[productId] || 0;
            showNotification(quantity === 0 ? '–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã' : '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–º–µ–Ω—å—à–µ–Ω–æ', 'info');
        } finally {
            button.disabled = false;
        }
    }

    async function removeFromCart(button) {
        if (!productId) {
            showNotification('ID —Ç–æ–≤–∞—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'danger');
            return;
        }

        if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) return;

        const originalText = button.innerHTML;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        button.disabled = true;

        try {
            const result = await cartRequest('/remove', { productId });
            updateCartUI(result);
            showNotification('–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã', 'info');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    function updateCartUI(result) {
        const quantity = result.quantities?.[productId] || 0;
        const cartSection = document.getElementById('cart-management-section');
        const addSection = document.getElementById('add-to-cart-section');
        const quantityBadge = document.getElementById('cartQuantity');
        const quantityValue = document.getElementById('cartQuantityValue');
        const decreaseBtn = document.getElementById('decrease-btn');

        if (quantityBadge) quantityBadge.textContent = quantity;
        if (quantityValue) quantityValue.textContent = quantity;
        if (decreaseBtn) decreaseBtn.disabled = quantity <= 1;

        updateHeaderBadge(result.totalQuantity);

        if (quantity > 0) {
            cartSection.style.display = 'block';
            cartSection.classList.add('fade-in');
            addSection.style.display = 'none';
        } else {
            cartSection.style.display = 'none';
            addSection.style.display = 'block';
            addSection.classList.add('fade-in');
        }
    }

    function updateHeaderBadge(totalQuantity) {
        let badge = document.getElementById('cart-badge');
        const container = document.querySelector('.cart-indicator a');

        if (totalQuantity > 0) {
            if (!badge && container) {
                badge = document.createElement('span');
                badge.id = 'cart-badge';
                badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                container.appendChild(badge);
            }
            if (badge) {
                badge.textContent = totalQuantity;
                badge.style.display = 'inline-block';
            }
        } else if (badge) {
            badge.style.display = 'none';
        }
    }

    function showNotification(message, type = 'success') {
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            document.body.appendChild(container);
        }

        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show mb-2 shadow`;
        const icon = type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle';
        alert.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${icon} fs-5 me-2"></i>
                <div class="flex-grow-1">${message}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        container.appendChild(alert);
        setTimeout(() => alert.remove(), 3000);
    }

    async function loadCartState() {
        try {
            const response = await fetch('/api/cart/state');
            if (response.ok) {
                const result = await response.json();
                updateCartUI(result);
            }
        } catch (error) {
            console.error('Error loading cart state:', error);
        }
    }
    /*]]>*/
</script>
</body>
</html>