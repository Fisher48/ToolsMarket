<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang="RU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YML Импорт товаров</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        .stats-card {
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .stats-card.categories { border-left-color: #0d6efd; }
        .stats-card.products { border-left-color: #198754; }
        .stats-card.attributes { border-left-color: #ffc107; }

        /* Индикатор загрузки */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid #0d6efd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            width: 300px;
            margin-top: 20px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 0 5px;
            color: #6c757d;
        }
        .step.active {
            background: #0d6efd;
            color: white;
        }
        .step.completed {
            background: #198754;
            color: white;
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="container-fluid">

        <!-- Заголовок -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0 text-gray-800">
                <i class="bi bi-file-earmark-arrow-up me-2"></i>YML Импорт товаров из XML
            </h1>
            <a href="/admin/products" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>К списку товаров
            </a>
        </div>

        <!-- Основная карточка -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-primary text-white">
                <h6 class="m-0 fw-bold">
                    <i class="bi bi-cloud-download me-2"></i>Загрузка каталога из YML
                </h6>
            </div>
            <div class="card-body">

                <!-- Форма импорта -->
                <form th:action="@{/admin/parser/run}" method="post"
                      id="importForm" class="mb-4">

                    <div class="row">
                        <div class="col-md-9">
                            <div class="mb-3">
                                <label for="xmlUrl" class="form-label fw-bold">
                                    <i class="bi bi-link-45deg me-1"></i>URL YML файла
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-globe"></i></span>
                                    <input type="url" class="form-control form-control-lg" id="xmlUrl"
                                           name="xmlUrl"
                                           th:value="${xmlUrl != null ? xmlUrl : defaultUrl}"
                                           placeholder="https://example.com/export.xml"
                                           required>
                                </div>
                                <div class="form-text text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Укажите ссылку на YML файл в формате Яндекс.Маркет
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="mb-3 w-100">
                                <button type="submit" class="btn btn-primary btn-lg w-100"
                                        id="submitBtn" th:disabled="${running}">
                                    <i class="bi bi-play-fill me-1"></i>
                                    <span th:if="${running}">Импорт...</span>
                                    <span th:unless="${running}">Запустить импорт</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Индикатор этапов импорта (показывается во время выполнения) -->
                <div id="stepIndicator" class="step-indicator" th:if="${running}" style="display: none;">
                    <div class="step" id="step1">1. Загрузка XML</div>
                    <div class="step" id="step2">2. Импорт категорий</div>
                    <div class="step" id="step3">3. Импорт товаров</div>
                    <div class="step" id="step4">4. Завершение</div>
                </div>

                <!-- Индикатор загрузки -->
                <div id="loadingIndicator" class="text-center py-5"
                     th:if="${running}" style="display: none;">
                    <div class="spinner mb-4"></div>
                    <h5 class="text-primary mb-3" id="loadingMessage">Идет импорт данных...</h5>
                    <p class="text-muted" id="loadingDetail">Пожалуйста, подождите. Это может занять несколько минут.</p>
                    <div class="progress-container mx-auto">
                        <div class="progress" style="height: 10px;">
                            <div id="importProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                                 style="width: 0%;"></div>
                        </div>
                    </div>
                </div>

                <!-- Сообщение об ошибке -->
                <div class="alert alert-danger mt-3" th:if="${error}" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span th:text="${error}"></span>
                </div>

                <!-- Результаты импорта -->
                <div th:if="${result != null}" class="mt-4">
                    <div class="card border-success" th:classappend="${!result.success} ? 'border-danger' : ''">
                        <div class="card-header" th:classappend="${result.success} ? 'bg-success text-white' : 'bg-danger text-white'">
                            <h5 class="mb-0">
                                <i class="bi" th:classappend="${result.success} ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
                                <span th:text="${result.success} ? 'Импорт успешно завершен' : 'Ошибка импорта'"></span>
                            </h5>
                        </div>
                        <div class="card-body">

                            <!-- Детальная статистика -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-4">
                                    <div class="stats-card categories p-3 bg-light rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="bi bi-folder2-open fs-1 text-primary"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h3 class="mb-0" th:text="${result.categoriesImported}">0</h3>
                                                <span class="text-muted">Категорий импортировано</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card products p-3 bg-light rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="bi bi-box-seam fs-1 text-success"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h3 class="mb-0" th:text="${result.offersImported}">0</h3>
                                                <span class="text-muted">Товаров импортировано</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stats-card attributes p-3 bg-light rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0">
                                                <i class="bi bi-tags fs-1 text-warning"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h3 class="mb-0">-</h3>
                                                <span class="text-muted">Атрибутов создано</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Таблица с деталями -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Детали импорта</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tr>
                                                    <th>Статус:</th>
                                                    <td>
                                                        <span th:if="${result.success}" class="badge bg-success">Успешно</span>
                                                        <span th:unless="${result.success}" class="badge bg-danger">Ошибка</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Категории:</th>
                                                    <td th:text="${result.categoriesImported}"></td>
                                                </tr>
                                                <tr>
                                                    <th>Товары:</th>
                                                    <td th:text="${result.offersImported}"></td>
                                                </tr>
                                                <tr th:if="${result.error}">
                                                    <th>Ошибка:</th>
                                                    <td class="text-danger" th:text="${result.error}"></td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Информация</h6>
                                        </div>
                                        <div class="card-body">
                                            <table class="table table-sm">
                                                <tr>
                                                    <th>URL импорта:</th>
                                                    <td class="text-truncate" style="max-width: 200px;"
                                                        th:text="${xmlUrl}"></td>
                                                </tr>
                                                <tr>
                                                    <th>Время импорта:</th>
                                                    <td th:text="${#dates.format(#dates.createNow(), 'dd.MM.yyyy HH:mm:ss')}"></td>
                                                </tr>
                                                <tr>
                                                    <th>Тип импорта:</th>
                                                    <td>YML (Яндекс.Маркет)</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Кнопки действий -->
                            <div class="mt-4 d-flex gap-2">
                                <a href="/admin/products" class="btn btn-primary">
                                    <i class="bi bi-box-seam me-1"></i>Просмотр товаров
                                </a>
                                <a href="/admin/categories" class="btn btn-outline-primary">
                                    <i class="bi bi-folder2-open me-1"></i>Управление категориями
                                </a>
                                <button type="button" class="btn btn-outline-secondary"
                                        onclick="window.location.href='/admin/parser'">
                                    <i class="bi bi-arrow-repeat me-1"></i>Новый импорт
                                </button>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Информация о формате -->
                <div class="card mt-4 border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="m-0">
                            <i class="bi bi-info-circle me-2"></i>
                            О YML импортере
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="bi bi-check-circle text-success me-2"></i>Что импортируется:</h6>
                                <ul class="mb-3">
                                    <li>Категории товаров (с поддержкой вложенности)</li>
                                    <li>Товары с основными полями (название, цена, описание)</li>
                                    <li>Характеристики товаров (параметры)</li>
                                    <li>Изображения товаров</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-gear text-secondary me-2"></i>Как работает:</h6>
                                <ul class="mb-3">
                                    <li><strong>Этап 1:</strong> Загрузка и парсинг XML</li>
                                    <li><strong>Этап 2:</strong> Импорт всех категорий</li>
                                    <li><strong>Этап 3:</strong> Импорт всех товаров</li>
                                    <li><strong>Этап 4:</strong> Сохранение связей</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-light border mt-2 mb-0">
                            <i class="bi bi-lightbulb me-2 text-warning"></i>
                            <strong>Формат YML:</strong> Стандарт Яндекс.Маркет. Используется
                            <code>vendorCode</code> как уникальный SKU товара. При повторном импорте товары обновляются.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript для асинхронной отправки -->
<th:block layout:fragment="scripts">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('importForm');
            const submitBtn = document.getElementById('submitBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const stepIndicator = document.getElementById('stepIndicator');
            const loadingMessage = document.getElementById('loadingMessage');
            const loadingDetail = document.getElementById('loadingDetail');
            const progressBar = document.getElementById('importProgress');

            // Обновление шагов импорта
            function updateStep(step) {
                for (let i = 1; i <= 4; i++) {
                    const stepEl = document.getElementById('step' + i);
                    if (stepEl) {
                        stepEl.className = 'step';
                        if (i < step) stepEl.className = 'step completed';
                        else if (i === step) stepEl.className = 'step active';
                    }
                }

                const messages = {
                    1: { msg: 'Загрузка XML файла...', detail: 'Чтение и парсинг XML структуры' },
                    2: { msg: 'Импорт категорий...', detail: 'Создание и обновление категорий' },
                    3: { msg: 'Импорт товаров...', detail: 'Обработка товаров и характеристик' },
                    4: { msg: 'Завершение импорта...', detail: 'Сохранение данных и связей' }
                };

                if (messages[step]) {
                    loadingMessage.textContent = messages[step].msg;
                    loadingDetail.textContent = messages[step].detail;
                }

                // Обновляем прогресс
                if (progressBar) {
                    progressBar.style.width = (step * 25) + '%';
                }
            }

            form.addEventListener('submit', function(e) {
                // Показываем индикатор загрузки
                loadingIndicator.style.display = 'block';
                stepIndicator.style.display = 'flex';
                submitBtn.disabled = true;

                // Начинаем с шага 1
                updateStep(1);

                // Анимация шагов
                let currentStep = 1;
                const stepInterval = setInterval(function() {
                    if (currentStep < 4) {
                        currentStep++;
                        updateStep(currentStep);
                    } else {
                        clearInterval(stepInterval);
                    }
                }, 3000); // Меняем шаг каждые 3 секунды

                // Таймаут для очень долгих операций
                setTimeout(function() {
                    if (submitBtn.disabled) {
                        loadingMessage.innerHTML = '<span class="text-warning">Операция выполняется дольше обычного...</span>';
                        loadingDetail.innerHTML = '<span class="text-muted">Пожалуйста, не закрывайте страницу. Идет обработка большого количества данных.</span>';
                    }
                }, 30000);

                // Очищаем интервал при завершении (через 5 минут)
                setTimeout(function() {
                    clearInterval(stepInterval);
                }, 300000);
            });

            // AJAX версия для фонового импорта
            window.runYmlImport = function(url) {
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/admin/parser/run', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        console.log('Upload progress: ' + percentComplete + '%');
                    }
                };

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        location.reload();
                    } else {
                        alert('Ошибка импорта: ' + xhr.statusText);
                    }
                };

                xhr.send('xmlUrl=' + encodeURIComponent(url));
            };
        });
    </script>
</th:block>
</body>
</html>