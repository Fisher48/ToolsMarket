events {
    worker_connections 1024;
}

http {

    # =========================
    # RATE LIMIT ZONES
    # =========================
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=order_limit:10m rate=2r/s;

    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

    # =========================
    # STATUS CODE FOR RATE LIMIT
    # =========================
    limit_req_status 429;  # Too Many Requests


     # =========================
     # Глобальный лимит загрузки файлов
     # =========================
     client_max_body_size 50M;
     client_body_buffer_size 128k;
     client_body_timeout 300s;

    # =========================
    # GZIP COMPRESSION
    # =========================
    gzip on;
    gzip_disable "msie6";

    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;

    gzip_min_length 1024;
    gzip_buffers 16 8k;

    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/json
        application/xml
        application/rss+xml
        image/svg+xml;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;

    server_tokens off;   # ❗ не светим версию nginx

    upstream spring_app {
        server tools-market-app:8080;
        keepalive 32;
    }

    upstream grafana {
        server grafana:3000;
        keepalive 8;
    }

    # =========================
    # ОСНОВНОЙ СЕРВЕР (ТОЛЬКО ОДИН!)
    # =========================
    server {
        listen 80;
        server_name toolsmarket48.ru www.toolsmarket48.ru localhost 127.0.0.1 _;

        # Let's Encrypt verification
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        limit_conn conn_limit 20;

        # =========================
        # Глобальный лимит загрузки файлов
        # =========================
        client_max_body_size 50M;
        client_body_buffer_size 128k;
        client_body_timeout 300s;

        # =========================
        # SECURITY HEADERS (MINIMUM)
        # =========================
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy strict-origin-when-cross-origin always;

        # =========================
        # STATIC IMAGES
        # =========================

        # Статика (загруженные файлы)
        location /images/ {
            alias /app/uploads/;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000, immutable";
            access_log off;
        }

        # grafana
#         location /grafana/ {
  #           proxy_pass http://grafana;
    #         proxy_set_header Host $host;
      #       proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          #   proxy_set_header X-Forwarded-Proto $scheme;

            # Увеличиваем таймауты для графаны
           #  proxy_connect_timeout 30s;
          #   proxy_read_timeout 300s;
          #   proxy_send_timeout 300s;
      #   }

        # =========================
        # PROMETHEUS NGINX EXPORTER
        # =========================
        location /stub_status {
            stub_status;
            allow 172.16.0.0/12;  # ❗ только docker network
            deny all;
        }

        # =========================
        # ORDERS
        # =========================
        location /order {
            limit_req zone=order_limit burst=5;
            proxy_pass http://spring_app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # =========================
        # SPRING BOOT BACKEND
        # =========================
        location / {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://spring_app;

            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_connect_timeout 30s;
            proxy_read_timeout 60s;
            proxy_send_timeout 60s;

            client_max_body_size 10M;  # соответствует Spring
        }
    }
}