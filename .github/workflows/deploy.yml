name: Deploy with Docker Hub

on:
  push:
    branches: [main]

env:
  REGISTRY: docker.io
  IMAGE_NAME: fisher48/tools-market-app  # ‚Üê –¢–≤–æ–π Docker Hub –ª–æ–≥–∏–Ω/—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Log in to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

      - name: Build and push Docker image
        run: |
          # –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º –≤ Docker Hub
          docker build -t ${{ env.IMAGE_NAME }}:latest .
          docker push ${{ env.IMAGE_NAME }}:latest
          
          # –¢–∞–∫–∂–µ –ø—É—à–∏–º —Å —Ç–µ–≥–æ–º –ø–æ –∫–æ–º–º–∏—Ç—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.TOOLSMARKET_SSH_KEY }}

      - name: Add server to known hosts
        run: ssh-keyscan -H ${{ secrets.TOOLSMARKET_SERVER_HOST }} >> ~/.ssh/known_hosts

      # ======== –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í ========
      - name: Copy project files to server
        run: |
          SERVER="${{ secrets.TOOLSMARKET_SERVER_USER }}@${{ secrets.TOOLSMARKET_SERVER_HOST }}"

          ssh $SERVER "mkdir -p ~/toolsmarket/nginx/conf.d"

          # üëâ –ö–æ–ø–∏—Ä—É–µ–º compose
          scp docker-compose.yml $SERVER:~/toolsmarket/docker-compose.yml

          # üëâ –ö–û–ü–ò–†–£–ï–ú –í–°–Æ –ü–ê–ü–ö–£
          scp -r nginx $SERVER:~/toolsmarket/

      - name: Deploy application
        run: |
          ssh ${{ secrets.TOOLSMARKET_SERVER_USER }}@${{ secrets.TOOLSMARKET_SERVER_HOST }} "
            set -e
          
            echo '=== –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ ==='
          
            # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É
            mkdir -p ~/toolsmarket
          
            cd ~/toolsmarket
          
            echo '‚úÖ –ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞'
          
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –µ—Å—Ç—å
            echo '–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:'
            ls -la ~/
          
            echo '=== –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π ==='
          
            # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Docker Hub (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            # echo '${{ secrets.DOCKER_PASSWORD }}' | docker login \
            #   -u '${{ secrets.DOCKER_USERNAME }}' \
            #   --password-stdin
          
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑ (Docker Hub –ø—É–±–ª–∏—á–Ω—ã–π, –ª–æ–≥–∏–Ω –Ω–µ –Ω—É–∂–µ–Ω)
            echo '–û–±–Ω–æ–≤–ª—è–µ–º Docker –æ–±—Ä–∞–∑...'
            docker compose pull app
            echo '‚úÖ –û–±—Ä–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω'
          
            # –ó–∞–ø—É—Å–∫–∞–µ–º
            echo '–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã...'
            docker compose up -d --remove-orphans
            echo '‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã'
          
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...'
            sleep 20
            if curl -f http://localhost:8080/actuator/health; then
              echo '‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'
            else
              echo '‚ùå –û—à–∏–±–∫–∞ health check'
              docker compose logs app --tail=20
              exit 1
            fi
          
            # –û—á–∏—â–∞–µ–º
            echo '–û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã...'
            docker image prune -f
            docker system prune -f
            echo '‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'
          
            echo 'üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!'
          "