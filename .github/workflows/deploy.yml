name: Deploy

on:
  push:
    branches: [main]
    tags: ['v*']  # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–ª—è —Ä–µ–ª–∏–∑–æ–≤

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: tools-market-app

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}  # –ú–æ–∂–Ω–æ –∏ GHCR_TOKEN

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch  # main -> ghcr.io/...:main
            type=ref,event=tag     # v1.0.0 -> ghcr.io/...:v1.0.0
            type=sha               # ghcr.io/...:sha-abc123

      - name: Build and push
        run: |
          # –ü—Ä–æ—Å—Ç–æ —Å–æ–±–∏—Ä–∞–µ–º –∏ –ø—É—à–∏–º
          docker build -t ghcr.io/fisher48/tools-market-app:latest .
          docker push ghcr.io/fisher48/tools-market-app:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.TOOLSMARKET_SSH_KEY }}

      - name: Add server to known hosts
        run: ssh-keyscan -H ${{ secrets.TOOLSMARKET_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Copy configs to server
        run: |
          # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥–∏
          scp docker-compose.yml ${{ secrets.TOOLSMARKET_SERVER_USER }}@${{ secrets.TOOLSMARKET_SERVER_HOST }}:~/toolsmarket/
          scp -r nginx/ ${{ secrets.TOOLSMARKET_SERVER_USER }}@${{ secrets.TOOLSMARKET_SERVER_HOST }}:~/toolsmarket/nginx/

      - name: Deploy application
        run: |
          ssh ${{ secrets.TOOLSMARKET_SERVER_USER }}@${{ secrets.TOOLSMARKET_SERVER_HOST }} "
            set -e
            cd ~/toolsmarket
          
            echo '=== –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π ==='
          
            # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GHCR
            echo '${{ secrets.GITHUB_TOKEN }}' | docker login ${{ env.REGISTRY }} \
              -u '${{ github.repository_owner }}' \
              --password-stdin
            echo '‚úÖ –õ–æ–≥–∏–Ω –≤ GHCR —É—Å–ø–µ—à–µ–Ω'
          
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π –æ–±—Ä–∞–∑ —Ç—è–Ω—É—Ç—å
            if [[ '${{ github.ref }}' == 'refs/tags/'* ]]; then
              # –ï—Å–ª–∏ —Ä–µ–ª–∏–∑–Ω—ã–π —Ç–µ–≥
              TAG='${{ github.ref_name }}'
            else
              # –ï—Å–ª–∏ –æ–±—ã—á–Ω—ã–π –ø—É—à –≤ main
              TAG='latest'
            fi
          
            IMAGE='${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG'
            echo \"–ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—Ä–∞–∑: \$IMAGE\"
          
            # –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑
            echo '–û–±–Ω–æ–≤–ª—è–µ–º Docker –æ–±—Ä–∞–∑...'
            docker compose pull app
            echo '‚úÖ –û–±—Ä–∞–∑ –æ–±–Ω–æ–≤–ª–µ–Ω'
          
            # –ó–∞–ø—É—Å–∫–∞–µ–º
            echo '–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã...'
            docker compose up -d --remove-orphans
            echo '‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã'
          
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º
            echo '–ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...'
            sleep 15
            if curl -f http://localhost:8080/actuator/health; then
              echo '‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'
            else
              echo '‚ùå –û—à–∏–±–∫–∞ health check'
              exit 1
            fi
          
            # –û—á–∏—â–∞–µ–º
            echo '–û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã...'
            docker image prune -f
            docker system prune -f
            echo '‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞'
          
            echo 'üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!'
            echo \"–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ: https://toolsmarket48.ru\"
          "